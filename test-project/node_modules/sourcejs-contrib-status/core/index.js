var fs = require('fs-extra');
var path = require('path');
var forever = require('tinyforever');

var config = {
    dataPath: path.join(__dirname, '../data', 'status.json')
};

global.app.get('/plugins/status', function(req, res){
    var status = fs.readJsonSync(config.dataPath, {throws: false});

    if (status) {
        res.status(200).json(status);
    } else {
        res.status(404).json({});
    }
});

// Run child socket server
var child = new (forever.Monitor)(path.join(__dirname, 'socketServer.js'), config.forever);

child.on('start', function() {
    global.log.info('Socket server started.');
});

child.on('stderr', function() {
    global.log.info('Socket server error.');
});

child.start();

process.on('exit', function () {
    child.stop();
});