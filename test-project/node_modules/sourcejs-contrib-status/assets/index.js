require([
    'jquery',
    'sourceModules/module',
    'sourceModules/utils',
    'sourceLib/lodash',
    'node_modules/sourcejs-contrib-status/assets/lib/socket.io-1.3.5'
], function($, Module, utils, _, socketio) {

    'use strict';

    /**
     * @Object default module option values
     */
    var defaults = {
    };

    /**
     * @module Status - plugin for showing background tasks status
     *
     * @constructor
     *
     * @param [Object] config - auth inline configuration set of options
     */
    function Status(config) {
        var _this = this;
        var _config = config || {};
        var globalConfig = this.options.plugins && this.options.plugins.status ? this.options.plugins.status : {};

        this.conf = $.extend(true, {},
            defaults,
            _config.options,
            globalConfig
        );

        $(function() {
            _this.init();
        });
    }

    Status.prototype = Module.createInstance();
    Status.prototype.constructor = Status;

    Status.prototype.render = function(data){
        var $target = $('.source_info');
        var $statusContainer = $('.sourcejs-status');
        var $statusHtml = $('<ul class="sourcejs-status"></ul>');

        _.forOwn(data, function (value, key) {
            var msg = value.msg;
            var msgText = msg ? '. Message: ' + msg : '';

            $statusHtml.append('<li>' + key + ':' + value.status + msgText + '</li>')
        });

        if ($statusContainer.length === 0) {
            $target.append($statusHtml)
        } else {
            $statusContainer.replaceWith($statusHtml);
        }

        this.initSocket();
    };

    Status.prototype.initSocket = function(data){
        var socket = socketio(window.location.hostname + ':8081');
        var that = this;

        socket.on('status-update', function (data) {
            if (data) {
                that.render(data);
            }
        });
    };

    Status.prototype.init = function(){
        var that = this;

        $.get('/plugins/status')
            .done(function(data) {
                that.render(data);
            })
            .fail(function() {
            });
    };

    return new Status();
});